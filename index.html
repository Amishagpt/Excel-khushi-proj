<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fsrt Creator and Spooler</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=note_add"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #e0e7ff;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: auto;
        margin: 0;
      }
      .container {
        width: 80%;
        background-color: #e0e7ff;
        padding: 20px;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }
      .project-title {
        margin-top: 3rem;
        font-size: 24px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 20px;
      }
      .flex {
        display: flex;
      }
      .w-96 {
        width: 97%;
      }
      .gap-20 {
        gap: 5rem;
      }
      .mt-10 {
        margin-top: 2rem;
      }
      .items-center {
        align-items: center;
      }
      .title {
        display: flex;
      }
      .logoimg {
        margin-left: -470%;
        margin-top: 10px;
        width: 100px;
        height: 20px;
        margin-bottom: 50px;
      }
      .footer-email {
        font-size: 26px;
        color: #333;
        text-align: center;
        margin-top: 20px;
      }
      .header button {
        align-self: flex-start;
        margin-bottom: 10px;
        padding: 10px;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .header button span {
        font-size: 18px; /* Small text for "New" button */
      }
      .header .field-group {
        display: flex;
        margin-bottom: 10px;
        align-items: center;
      }
      .header .field-group label {
        width: 150px;
        margin-right: 10px;
      }
      .header .field-group input,
      .header .field-group textarea {
        width: 50%;
        padding: 8px;
      }
      .swr-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        width: 100%;
        margin-top: 20px;
      }
      .swr-group {
        background-color: #f8f9fa;
        border: 1px solid #d3d3d3;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .swr-group h3 {
        margin: 0 0 10px;
        font-size: 18px;
        text-align: center;
      }
      .swr-group textarea {
        padding: 8px;
        width: 100%;
        resize: none;
        margin-bottom: 10px;
        box-sizing: border-box;
      }
      .buttons {
        display: flex;
        justify-content: space-between;
      }
      button {
        cursor: pointer;
      }
      .spool-btn {
        align-self: flex-end;
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }
      .spool-btn:hover {
        background-color: #45a049;
      }
      .spool-btn svg {
        width: 32px;
        height: 32px;
        fill: white;
      }
      .checkbox-container {
        display: flex;
        align-items: center;
      }

      .checkbox-container label {
        display: flex;
        align-items: center;
        font-size: 15px;
      }
      .switch-buttons {
        width: 83%;
        height: 35px;
        border-radius: 8px;
        display: flex;
        background-color: white;
      }
      .post-spooler-btn {
        width: 50%;
        border-right: 8px;
        border-top-right-radius: 8px;
        border-bottom-right-radius: 8px;
        height: 35px;
        border: none;
      }
      .fsrt-spooler-btn {
        width: 50%;
        height: 35px;
        border: none;
      }
      #engineering-input {
        width: 100%;
        padding: 8px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      #input-container {
        width: 50%;
      }
      .engineering-checkbox {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-top: 10px;
      }
      #displayText {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-top: -20px;
        margin-left: 156px;
      }
      .fst {
        /* width: 100%; */
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
      }
      .fst label {
        font-size: 16px;
        color: #333;
      }
      .fst select,
      .fst input {
        width: 100%;
        padding: 10px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .switch-buttons button {
        font-weight: normal; /* Default font weight */
      }

      .switch-buttons .active {
        font-weight: bold; /* Bold font weight for active button */
      }
    </style>
  </head>
  <body>
    <div class="title">
      <div class="logo">
        <img
          class="logoimg"
          src="https://assets.micronbrands.com/content/dam/micron/brand-assets/logos/micron-logo/micron-logo-blk-tm-rgb.png/jcr:content/renditions/cq5dam.web.1280.1280.png"
        />
      </div>
      <div class="project-title">FSRT FGen Tool</div>
    </div>

    <div class="switch-buttons">
      <button class="fsrt-spooler-btn">Create</button>
      <button class="post-spooler-btn">Post Spooler</button>
    </div>
    <div class="container">
      <div class="header">
        <div class="flex gap-20 items-center">
          <button onclick="createNew()">
            <span class="material-symbols-outlined">note_add</span>
            New
          </button>
        </div>
        <!-- <div class="fst">
          <div>
            <label for="site">Site:</label><br /><br />
            <select id="site">
              <option value="" disabled selected>Select a site</option>
              <option value="site1">MSI</option>
              <option value="site2">MMP</option>
              <option value="site3">MSB</option>
              <option value="site3">MXA</option>
              <option value="site3">MMY</option>
              <option value="site3">MTB</option>
            </select>
          </div>
          <br />
          <div> -->
        <div class="flex gap-20">
          <div class="field-group">
            <label for="lot">Lot:</label>
            <input type="text" id="lot" placeholder="Enter Lot Number" />
          </div>
          <div class="field-group">
            <label for="deviceType">Device Type:</label>
            <input
              type="text"
              id="deviceType"
              placeholder="Enter Device Type"
            />
          </div>
        </div>
        <div class="flex gap-20">
          <div class="field-group">
            <label for="deviceConfig">Device Configuration:</label>
            <input
              type="text"
              id="deviceConfig"
              placeholder="Enter Device Configuration"
            />
          </div>
          <div class="field-group">
            <label for="comment">Comment:</label>
            <textarea
              id="comment"
              rows="2"
              placeholder="Enter your comment"
            ></textarea>
          </div>
          <div class="field-group checkbox-container">
            <label>
              <input type="checkbox" id="allCheckbox" />
              All
            </label>
          </div>
        </div>

        <!-- Engineering lot -->
        <div class="engineering-checkbox">
          <label>
            Engineering Lot:
            <input
              type="checkbox"
              id="engineering-lot-checkbox"
              onclick="displayText()"
            />
            <input
              type="text"
              id="displayText"
              value="u/summary/sums"
              style="display: none"
            />
            <!-- <button onclick="copyText()">Copy Text</button> -->
          </label>
          <!-- <div id="input-container" style="display: none">
              <input type="text" id="engineering-input" placeholder="Enter your path" />
            </div> -->
        </div>
      </div>

      <div id="swrContainer" class="swr-container"></div>

      <button class="spool-btn mt-10" onclick="spoolData()">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          height="32px"
          viewBox="0 -960 960 960"
          width="32px"
          fill="#ffffff"
        >
          <path
            d="M120-160v-640l760 320-760 320Zm80-120 474-200-474-200v140l240 60-240 60v140Zm0 0v-400 400Z"
          />
        </svg>
        <h3 class="add">Spool</h3>
      </button>
      <button
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#exampleModal"
      >
        EXCEL
      </button>
    </div>

    <div class="footer-email">tse_msi@micron.com</div>

    <div
      class="modal fade"
      id="exampleModal"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <input type="file" id="excelFile" />
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" id="enterBtn" class="btn btn-primary">
              Enter
            </button>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.min.js"
      integrity="sha384-VQqxDN0EQCkWoxt/0vsQvZswzTHUVOImccYmSyhJTp7kGtPed0Qcx8rK9h9YEgx+"
      crossorigin="anonymous"
    ></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const fsrtSpoolerBtn = document.querySelector(".fsrt-spooler-btn");
        const postSpoolerBtn = document.querySelector(".post-spooler-btn");

        // Function to set the active button based on the current page
        function setActiveButton(page) {
          if (page === "index.html") {
            fsrtSpoolerBtn.classList.add("active");
            postSpoolerBtn.classList.remove("active");
          } else if (page === "postSpooler.html") {
            postSpoolerBtn.classList.add("active");
            fsrtSpoolerBtn.classList.remove("active");
          }
        }

        // Example usage: Set the active button based on the current page
        // Replace 'creator' with 'postSpooler' to test the other button
        setActiveButton("index.html");
      });

      document.getElementById("comment").addEventListener("input", function () {
        const allCheckbox = document.getElementById("allCheckbox");
        const swrGroups = document.querySelectorAll(
          ".swr-group textarea[id^='comment']"
        );

        // Check or uncheck the checkbox based on input value
        allCheckbox.checked = this.value.trim() !== "";

        // Update all SWR group comments and hide them
        swrGroups.forEach((commentArea) => {
          commentArea.value = this.value; // Sync value
          toggleSWRCommentsVisibility(allCheckbox.checked); // Hide or show
        });
      });

      document
        .getElementById("allCheckbox")
        .addEventListener("change", function () {
          toggleSWRCommentsVisibility(this.checked);
        });

      // Function to hide or show SWR group comment fields based on checkbox state
      function toggleSWRCommentsVisibility(shouldHide) {
        const swrGroups = document.querySelectorAll(
          ".swr-group textarea[id^='comment']"
        );
        swrGroups.forEach((commentArea) => {
          commentArea.style.display = shouldHide ? "none" : "block"; // Toggle visibility
        });
      }

      function createNew() {
        document.getElementById("lot").value = "";
        // document.getElementById("site").value = "";
        document.getElementById("deviceType").value = "";
        document.getElementById("deviceConfig").value = "";
        document.getElementById("comment").value = "";
        document.getElementById("swrContainer").innerHTML = "";
        swrGroupCount = 1;
        createSWRGroup(swrGroupCount);
        toggleSWRCommentsVisibility(false); // Ensure fields are visible by default
      }

      function createSWRGroup(groupNumber) {
        const allCheckbox = document.getElementById("allCheckbox");
        const commentValue = document.getElementById("comment").value;

        const swrContainer = document.getElementById("swrContainer");
        const swrGroup = document.createElement("div");
        swrGroup.className = "swr-group";
        swrGroup.id = swrGroup${groupNumber};

        swrGroup.innerHTML = `
      <h3>SWR Group ${groupNumber}</h3>
      <div id="fidListContainer${groupNumber}" class="fid-list-container">
          <textarea id="fidList${groupNumber}" rows="4" placeholder="Enter FID list here"></textarea>
      </div>
      <textarea id="comment${groupNumber}" rows="2" placeholder="Enter the Comment">${commentValue}</textarea>
      <div class="buttons">
          <button onclick="addSWRGroup()">+</button>
          <button onclick="removeSWRGroup(${groupNumber})">-</button>
      </div>
    `;

        swrContainer.appendChild(swrGroup);

        if (allCheckbox.checked) {
          toggleSWRCommentsVisibility(true);
        }
      }

      function addSWRGroup() {
        if (swrGroupCount < 20) {
          swrGroupCount++;
          createSWRGroup(swrGroupCount);
        } else {
          alert("Maximum of 20 SWR groups reached.");
        }
      }

      function removeSWRGroup(groupNumber) {
        if (swrGroupCount > 1) {
          const swrGroup = document.getElementById(swrGroup${groupNumber});
          if (swrGroup) {
            swrGroup.remove();
            swrGroupCount--;
            renumberSWRGroups();
          }
        } else {
          alert("At least one SWR group must remain.");
        }
      }

      function renumberSWRGroups() {
        const swrGroups = document.querySelectorAll(".swr-group");
        swrGroups.forEach((group, index) => {
          const newGroupNumber = index + 1; // Renumber sequentially starting from 1
          group.id = swrGroup${newGroupNumber};
          group.querySelector("h3").textContent = SWR Group ${newGroupNumber};
          group.querySelector("textarea").id = fidList${newGroupNumber};
          const removeButton = group.querySelector(
            ".buttons button:nth-child(2)"
          );
          removeButton.setAttribute(
            "onclick",
            removeSWRGroup(${newGroupNumber})
          );
        });
      }

      function spoolData() {
        const lot = document.getElementById("lot").value;
        const deviceType = document.getElementById("deviceType").value;
        const deviceConfig = document.getElementById("deviceConfig").value;
        const comment = document.getElementById("comment").value;
        // const engineering_lot_input = document.getElementById("engineering-input").value;

        let swrGroups = [];
        for (let i = 1; i <= swrGroupCount; i++) {
          const fidList = document.getElementById(fidList${i}).value;
          const fidList_arr = fidList.split("\n");
          console.log(fidList_arr);
          const comment = document.getElementById(comment${i}).value;
          swrGroups.push({
            groupNumber: i,
            fidList: fidList_arr,
            groupComment: comment,
          });
        }

        const data = {
          lot,
          deviceType,
          deviceConfig,
          comment,
          swrGroups,
          //   engineering_lot_input
        };

        console.log(data);

        fetch("/spool-file", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        })
          .then((response) => {
            if (!response.ok) {
              return response.json().then((errorData) => {
                throw new Error(JSON.stringify(errorData));
              });
            }
            return response.json();
          })
          .then((data) => {
            alert("Instruction file created successfully!");
            console.log("Success:", data);
          })
          .catch((error) => {
            const errorData = JSON.parse(error.message);
            const errorMessage = errorData.error || error.message;
            alert(Error: ${errorMessage});
            console.error("Error:", error);
          });
        console.log(data);
      }

      window.onload = createNew;
    </script>

    <script>
      let excelData = null;

      document
        .getElementById("excelFile")
        .addEventListener("change", function (event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });

            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(sheet);

            if (json.length === 0) {
              alert("The Excel file is empty or invalid.");
              return;
            }

            excelData = json[0]; // Save the first data row
          };

          reader.readAsArrayBuffer(file);
        });

      document
        .getElementById("enterBtn")
        .addEventListener("click", function () {
          if (!excelData) {
            alert("Please upload a valid Excel file first.");
            return;
          }

          // const form = document.getElementById("dynamicForm");
          // form.innerHTML = ""; // Clear any previous form

          document.getElementById("lot").value = excelData["Lot ID"] || "";
          document.getElementById("deviceType").value =
            excelData["Device Type"] || "";
          document.getElementById("deviceConfig").value =
            excelData["Device Configuration"] || "";
          document.getElementById("comment").value = excelData["Comment"] || "";

          console.log("ok");
        });
    </script>
  </body>
</html>
